{"version":3,"sources":["../../src/replay.js"],"names":["profileRequests","config","reset","repeatMap","forEach","request","response","requestRepeatMap","invocations","matchingFunction","url","opts","actualOpts","actualUrl","actualOptsHeaders","JSON","stringify","headers","headersToOmit","actualRequestHeaders","urlMatches","RegExp","test","bodyMatches","content","body","headersMatch","methodMatches","method","responseOptions","status","statusCode","mock"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;kBAEe,UAACA,eAAD,EAAkBC,MAAlB,EAA6B;AAC1C,sBAAUC,KAAV;;AAEA,MAAMC,YAAY,uCAAsBH,eAAtB,CAAlB;;AAEAA,kBAAgBI,OAAhB,CAAwB,gBAA2B;AAAA,QAAxBC,OAAwB,QAAxBA,OAAwB;AAAA,QAAfC,QAAe,QAAfA,QAAe;;AACjD,QAAMC,mBAAmBJ,UAAU,gCAAeE,OAAf,CAAV,CAAzB;AACAE,qBAAiBC,WAAjB,IAAgC,CAAhC;;AAEA,QAAMC,mBAAmB,SAAnBA,gBAAmB,CAACC,GAAD,EAAMC,IAAN,EAAe;AACtC,UAAMC,aAAaD,QAAQD,GAA3B;AACA,UAAMG,YAAYF,OAAOD,GAAP,GAAaA,IAAIA,GAAnC;AACA,UAAMI,oBAAoBC,KAAKC,SAAL,CAAe,sBAAKJ,WAAWK,OAAhB,EAAyBhB,OAAOiB,aAAhC,CAAf,CAA1B;AACA,UAAMC,uBAAuBJ,KAAKC,SAAL,CAAe,sBAAKX,QAAQY,OAAb,EAAsBhB,OAAOiB,aAA7B,CAAf,CAA7B;;AAEA,UAAME,aAAa,IAAIC,MAAJ,4BAAoC,sBAAahB,QAAQK,GAArB,CAApC,QAAkE,GAAlE,EAAuEY,IAAvE,CAA4ET,SAA5E,CAAnB;AACA,UAAMU,cAAcX,aAAa,gCAAkBP,QAAQmB,OAA1B,EAAmCZ,WAAWa,IAA9C,CAAb,GAAmE,IAAvF;AACA,UAAMC,eAAed,aAAaE,sBAAsBK,oBAAnC,GAA0D,IAA/E;AACA,UAAMQ,gBAAgBf,aAAaA,WAAWgB,MAAX,KAAsBvB,QAAQuB,MAA3C,GAAoD,IAA1E;;AAEA,aAAOR,cAAcO,aAAd,IAA+BJ,WAA/B,IAA8CG,YAArD;AACD,KAZD;;AAcA,QAAMG,kBAAkB;AACtBJ,YAAMnB,SAASkB,OADO;AAEtBP,eAASX,SAASW,OAFI;AAGtBa,cAAQxB,SAASyB;AAHK,KAAxB;;AAMA,wBAAUC,IAAV,CACEvB,gBADF,EAEEoB,eAFF,EAGE,sCAAqBxB,OAArB,EAA8BJ,MAA9B,EAAsCE,SAAtC,CAHF;AAKD,GA7BD;AA8BD,C","file":"replay.js","sourcesContent":["import 'url';\nimport fetchMock from 'fetch-mock';\nimport escapeRegExp from 'lodash.escaperegexp';\nimport omit from 'lodash.omit';\nimport buildRequestId from './requestIdBuilder';\nimport stringIsSimilarTo from './stringSimilarity';\nimport buildFetchMockConfig from './fetchMockConfigBuilder';\nimport buildRequestRepeatMap from './requestRepeatMapBuilder';\n\nexport default (profileRequests, config) => {\n  fetchMock.reset();\n\n  const repeatMap = buildRequestRepeatMap(profileRequests);\n\n  profileRequests.forEach(({ request, response }) => {\n    const requestRepeatMap = repeatMap[buildRequestId(request)];\n    requestRepeatMap.invocations += 1;\n\n    const matchingFunction = (url, opts) => {\n      const actualOpts = opts || url;\n      const actualUrl = opts ? url : url.url;\n      const actualOptsHeaders = JSON.stringify(omit(actualOpts.headers, config.headersToOmit));\n      const actualRequestHeaders = JSON.stringify(omit(request.headers, config.headersToOmit));\n\n      const urlMatches = new RegExp(`^(https?://)?(www\\\\.)?${escapeRegExp(request.url)}$`, 'g').test(actualUrl);\n      const bodyMatches = actualOpts ? stringIsSimilarTo(request.content, actualOpts.body) : true;\n      const headersMatch = actualOpts ? actualOptsHeaders === actualRequestHeaders : true;\n      const methodMatches = actualOpts ? actualOpts.method === request.method : true;\n\n      return urlMatches && methodMatches && bodyMatches && headersMatch;\n    };\n\n    const responseOptions = {\n      body: response.content,\n      headers: response.headers,\n      status: response.statusCode,\n    };\n\n    fetchMock.mock(\n      matchingFunction,\n      responseOptions,\n      buildFetchMockConfig(request, config, repeatMap),\n    );\n  });\n};\n"]}